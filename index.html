<!doctype html>
<!--CKYLINMC-WORKS-->
<html>

<head>
    <title>Loading...</title>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta name="author" content="CKylinMC" />
    <meta http-equiv="keywords" content="TruthOrDareQuestions">
    <meta http-equiv="description" content="TruthOrDareQuestions site">
    <script>
        (function (window) {
            window.data = {
                curr: "none",
                addr: {
                    zxh: "https://cdn.jsdelivr.net/gh/CKylinMC/TOD_Dict@main/questions.json",
                    dmx: "https://cdn.jsdelivr.net/gh/CKylinMC/TOD_Dict@main/actions.json"
                },
                zxh:{},
                dmx:{},
                include:[],
                exclude:[]
            }
            window.page = {
                loaded: false,
                superTheme: false,
                isIndex: false,
                prevPage: "",
                prevPageBtnAlwaysShow: true,
                startload: new Date().valueOf(),
                endload: new Date().valueOf(),
                loadtiming: 0,
                title: "Document by CKylin",
                url: location.href,
                onload: () => {},
                autoexecs: [],
                callback: (func) => {
                    if (func instanceof Function) {
                        if(page.loaded) func.apply();
                        window.page.autoexecs.push(func);
                    } else console.error(func, "Can not reg as callback: not a function.");
                }
            };
        })(window);
    </script>
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/TODStyles.css">
    <link rel="stylesheet" href="/assets/css/modal.css">
    <link rel="stylesheet" href="/assets/css/PopNotify.css">
    <link rel="stylesheet" href="/assets/css/tips.css">
</head>

<body>
    <header>
        <span class="site-name" onclick="location.href='/'">真心话大冒险 for Online chat</span>
    </header>
    <div class="container loader" id="load-pending">
        <div style="
        font-size: xx-large;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%,-50%);
    ">
            <span class="loading-spinner" style="
            width: 36px;
            height: 36px;
        "> </span>
            <span class="texttip">正在加载...</span>
        </div>
    </div>
    <div class="container hidden" id="content-container">
        <h1>真心话大冒险</h1>


        <h3>输入参与人名称</h3>
        <div class="game-container">
            <ul id="game-names" class="multi-column-menu">
                
            </ul>
            <div class="game-btns">
            <button id="game-reset" onclick="resetGame()" class="red">重置</button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button onclick="Game_Go()" id="game-go">❤️ Go! ⚔️</button>
            </div>
            <div class="game-space">&nbsp;</div>
            <div id="game-result" class="hide">&nbsp;</div>
        </div>


        <h3>快速生成真心话问题或者大冒险要求！</h3>

        <ul class="multi-column-menu">
            <li><a href="javascript:void(0)" onclick="zxh()"
                    style="font-size: 1.4rem;font-weight: bold;text-align:center">❤️ 真心话</a></li>
            <li><a href="javascript:void(0)" onclick="dmx()"
                    style="font-size: 1.4rem;font-weight: bold;text-align:center">⚔️ 大冒险</a></li>
        </ul>
    </div>
    <div id="card-container">

    </div>
    <template id="temp-zxh">
        <div class="container hidden" id="card2">
            <h1>❤️ 真心话</h1>
            <div class="exclude-tags"></div>
            <div class="include-tags"></div>
            <div class="container-btns">
                <button onclick="resetFilter()" class="s-resetfilter s-hide red">重置筛选</button>
                <button onclick="randomOne()" class="s-random s-hide">🎲 随机</button>
            </div>
            <div id="zxh-container" class="s-container">
            </div>
        </div>
    </template>
    <template id="temp-dmx">
        <div class="container hidden" id="card2">
            <h1>⚔️ 大冒险</h1>
            <div class="exclude-tags"></div>
            <div class="include-tags"></div>
            <div class="container-btns">
                <button onclick="resetFilter()" class="s-resetfilter s-hide red">重置筛选</button>
                <button onclick="randomOne()" class="s-random s-hide">🎲 随机</button>
            </div>
            <div id="dmx-container" class="s-container">
            </div>
        </div>
    </template>

    <div class="helpbtn" onclick="helpModal()">?</div>

    <div class="top hide" onclick="goTop()">↑</div>

    <div class="random-btn" onclick="randomOne()">🎲</div>

    <script>
        page.title = "TruthOrDare Questions";
        // page.url = "/index.html";
        page.isIndex = true;

        page.callback(function () {
            let mode = getUrlParam("mode");
            if (mode) {
                if (mode == "z") {
                    load_zxh();
                    return;
                }
                if (mode == "d") {
                    load_dmx();
                    return;
                }
            }
        });
        

        page.callback(function () {
            loadCard2();
        });
        

        page.callback(function () {
            resetGame();
        });

        window.onscroll = e=>{
            let topbtn = get(".top");
            if(!topbtn) return;
            if(pageYOffset>200){
                if(topbtn.classList.contains("hide"))topbtn.classList.remove("hide");
            }else{
                if(!topbtn.classList.contains("hide"))topbtn.classList.add("hide");
            }
        }

        function goTop(){
            scrollTo({ 
                top: 0, 
                behavior: "smooth" 
            });
        }

        function helpModal(){
            openModal(modalTitle("关于“真心话大冒险”")+`
            <h2>使用方法</h2>
            真心话大冒险界面分为上下两部分，默认只显示上半部分。上半部分中，可以输入参与人姓名，输入两个以上参与人后，可以点击“Go!”按钮，会自动在上面所输入人名中选出赢家和输家，快速开局。点击重置可以重置整个界面，包括输入的参与人也会被清空。<br><br>
            下半部分默认不显示，需要点击“真心话”或者“大冒险”按钮选择进入一个模式，进入后自动跳转到对应模式的卡片，将列出所有的问题或要求。点击“随机”可以快速随机到一个卡片。点击卡片的标签可以选择必须包含这个标签，或者禁止包含这个标签。当选择禁止包含或必须包含后，在下半部分的顶部会显示已经筛选的条件标签，点击即可取消。点击重置取消所有筛选。<br><br>
            右下角浮动按钮有“快速随机”和“返回顶部”。“快速随机”按钮仅会在显示下半部分卡片后显示，点击即可快速随机卡片。“返回顶部”按钮仅会在滚动到非顶部区域时显示，点击可以快速回到顶部。
            <br><br>
            <h2>关于“真心话大冒险”</h2>
            这是 <a href="https://www.ckylin.site">我 (CKylinMC)</a> 使用以前的练手作业改的一个项目，代码上仅仅是可以运行的程度，但是所有的功能都是自己写的，包括页面样式。<br><br>
            <b>项目开源地址：</b><br><a href="https://github.com/ckylinmc/TOD_Web">真心话大冒险 网页</a><br><a href="https://github.com/ckylinmc/TOD_Dict">真心话大冒险 语料</a>
            <br><br>
            欢迎反馈或贡献！
            `);
        }

        function loadCard2(){
            let card2 = get("#card2");
            if (card2) {
                card2.className = "container anim-in delay";
            }
        }

        function zxh() {
            // location.href = "?mode=z";
            load_zxh();
        }

        function dmx() {
            // location.href = "?mode=d";
            load_dmx();
        }

        function load_zxh() {
            window.data.curr = "zxh";
            showTips("❤️ 真心话");
            let container = get("#card-container");
            if(!container) return;
            let tmpl = get("#temp-zxh");
            if(tmpl){
                container.innerHTML = tmpl.innerHTML;
                loadCard2();
                setTimeout(()=>{
                    scrollTo(0,container.offsetTop-70);
                },200);
                loadList("zxh");
            }
        }

        function load_dmx() {
            window.data.curr = "dmx";
            showTips("⚔️ 大冒险");
            let container = get("#card-container");
            if(!container) return;
            let tmpl = get("#temp-dmx");
            if(tmpl){
                container.innerHTML = tmpl.innerHTML;
                loadCard2();
                setTimeout(()=>{
                    scrollTo(0,container.offsetTop-70);
                },200);
                loadList("dmx");
            }
        }

        function loadData_zxh(force = false,callback){
            waitModal();
            if(force||Object.keys(window.data.zxh).length==0){
                CKFetch.get(window.data.addr.zxh+"?v="+Math.random()).then(r=>r.json()).then(
                    json =>{
                        window.data.zxh = json;
                        closeModal();
                        if(callback instanceof Function) callback.apply();
                    }
                );
            }else {
                closeModal();
                if(callback instanceof Function) callback.apply();
            }
        }

        function loadData_dmx(force = false,callback = ()=>{}){
            waitModal();
            if(force||Object.keys(window.data.dmx).length==0){
                CKFetch.get(window.data.addr.dmx+"?v="+Math.random()).then(r=>r.json()).then(
                    json =>{
                        window.data.dmx = json;
                        closeModal();
                        if(callback instanceof Function) callback.apply();
                    }
                );
            }else {
                closeModal();
                if(callback instanceof Function) callback.apply();
            }
        }
        
        function tagsModal(e){
            let t = e.target;
            let tagn = t.innerHTML;
            let modaldom = `
            <button onclick="addExcludeTag('${tagn}')" class="red" style="display:inline-block;margin: 5px auto !important;">排除此标签</button>
            <button onclick="addIncludeTag('${tagn}')" class="green" style="display:inline-block;margin: 5px auto !important;">必须包括此标签</button>
            <button onclick="closeModal()" style="display:block;margin: 5px auto !important">关闭</button>
            `;
            openModal(modalTitle("'"+tagn+"'")+modaldom,"center","nobtn");
        }

        function resetFilter(){
            window.data.exclude = [];
            window.data.include = [];
            loadList(window.data.curr);
        }

        function updateTagsDisplay(){
            let ul,arrs;
            if(window.data.exclude.length){
                ul = document.createElement("ul");
                ul.className = "s-tags";
                window.data.exclude.forEach(e=>{
                    let li = document.createElement("li");
                    li.className = "s-tag-item";
                    li.innerHTML = e;
                    li.onclick = ev=>rmExcludeTag(ev.target.innerHTML);
                    ul.appendChild(li);
                });
                arrs = document.querySelectorAll(".exclude-tags");
                arrs.forEach(e=>{
                    e.innerHTML = "<h2>排除：</h2>";
                    e.appendChild(ul);
                });
            }else{
                arrs = document.querySelectorAll(".exclude-tags");
                arrs.forEach(e=>{
                    e.innerHTML = "";
                });
            }
            
            if(window.data.include.length){
                ul = document.createElement("ul");
                ul.className = "s-tags";
                window.data.include.forEach(e=>{
                    let li = document.createElement("li");
                    li.className = "s-tag-item";
                    li.innerHTML = e;
                    li.onclick = ev=>rmIncludeTag(ev.target.innerHTML);
                    ul.appendChild(li);
                });
                arrs = document.querySelectorAll(".include-tags");
                arrs.forEach(e=>{
                    e.innerHTML = "<h2>包含：</h2>";
                    e.appendChild(ul);
                });
            }else{
                arrs = document.querySelectorAll(".include-tags");
                arrs.forEach(e=>{
                    e.innerHTML = "";
                });
            }
        }

        function rmExcludeTag(t){
            console.log(t);
            window.data.exclude.remove(t);
            loadList(window.data.curr);
            closeModal();
        }

        function rmIncludeTag(t){
            window.data.include.remove(t);
            loadList(window.data.curr);
            closeModal();
        }

        function addExcludeTag(t){
            window.data.exclude.push(t);
            loadList(window.data.curr);
            closeModal();
        }

        function addIncludeTag(t){
            window.data.include.push(t);
            loadList(window.data.curr);
            closeModal();
        }

        function randomOne(){
            let container = get("#"+window.data.curr+"-container");
            if(!container) return;
            let arrs = [...container.children];
            if(arrs.length<1) return;
            let newarr = arrs.shuffle();
            let e = document.createEvent("MouseEvents");
            e.initEvent("click",true,true);
            newarr[0].dispatchEvent(e);
            scrollTo({ 
                top: newarr[0].offsetTop+innerHeight/2, 
                behavior: "smooth" 
            });
            showTips("🎲 随机模式");
        }

        function loadList(type){
            let func = ()=>{
                let data = window.data.curr=="zxh"?window.data.zxh:(window.data.curr=="dmx"?window.data.dmx:{});
                if(data=={}) return;
                let items = data.data;
                if(!items) return;
                let container = get("#"+type+"-container");
                if(!container) return;
                container.innerHTML = "";
                let exclude = window.data.exclude;
                let include = window.data.include;
                items.forEach(e=>{
                    let flag = true;
                    exclude.forEach(t=>{
                        if(e.tags.includes(t)){
                            flag = false;
                            return;
                        }
                    });
                    include.forEach(t=>{
                        if(!e.tags.includes(t)){
                            flag = false;
                            return;
                        }
                    });
                    if(!flag)return;
                    container.appendChild(createItem(e.name,e.tags,true));
                    updateTagsDisplay();

                    /* display random btn */
                    let btn = get(".random-btn");
                    let atop = get(".top");
                    let topOffset = 0;
                    if(atop) topOffset = atop.offsetTop-atop.offsetHeight-10;
                    if(btn) {
                        btn.style.top = topOffset + "px";
                        if(!btn.classList.contains("show")) btn.classList.add("show");
                    }
                });
            }
            if(type=="zxh") return loadData_zxh(false,func);
            else return loadData_dmx(false,func);
        }

        function makeTag(name = "-",asdom = false){
            if(asdom) {
                let li = document.createElement("li");
                li.className = "s-tag-item";
                li.innerHTML = name;
                li.onclick = e=>tagsModal(e);
                return li;
            }
            else return `<li class="s-tag-item">{name}</li>`;
        }

        function createItem(title = "@#$%^&*",tags = [],asdom = false) {
            if(asdom){
                let div = document.createElement("div");
                div.onclick = e=>{
                    let flag = true;
                    let targetdom;
                    e.path.forEach(i=>{
                        console.log(i.tagName);
                        if(i.tagName&&i.tagName.toLowerCase()=="li") flag = false;
                        if(i.classList&&i.classList.contains("s-item")) targetdom = i;
                    });
                    if(!flag)return;
                    let allactive = document.querySelectorAll(".s-item-active");
                    [...allactive].forEach(e=>e.classList.remove("s-item-active"));
                    targetdom.classList.add("s-item-active");
                }
                div.setAttribute("data-s-tags",tags.join(","));
                div.className = "s-item";
                let h2 = document.createElement("h2");
                h2.innerHTML = title;
                let ul = document.createElement("ul");
                ul.className = "s-tags";
                tags.forEach(e=>ul.appendChild(makeTag(e,true)));
                div.appendChild(h2);
                div.appendChild(ul);
                return div;
            }else{
                let tagshtml = "";
                tags.forEach(e=>tagshtml += makeTag(e));
                let domhtml = ` <div class="s-item" data-s-tags="%TAGSTR%">
                                    <h2>%TITLE%</h2>
                                    <ul class="s-tags">
                                        %TAGS%
                                    </ul>
                                </div>`;
                domhtml = domhtml.replace("%TITLE%",title).replace("%TAGS%",tagshtml).replace("%TAGSTR%",tags.join(","));
                return domhtml;
            }
        }

        function tip(e, t) {
            let el = e instanceof HTMLElement ? e : e.target;
            let title = "";
            if (el) {
                title = el.innerHTML;
            }
            openModal(modalTitle(title) + t, "success", "关闭提示");
        }
    </script>
    <footer>
        推荐在电脑中使用Chrome、Firefox浏览器访问<br>
        <a href="https://github.com/CKylinMC/TOD_Web/issues/new/choose">反馈页面bug</a><br>
        <a href="https://github.com/CKylinMC/TOD_Dict/issues/new/choose">添加新的词条</a><br>
        <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span><br>
        <a href="https://github.com/CKylinMC/TOD_Web">CKylinMC</a> &copy; 2020
    </footer>
    <script src="/assets/js/Cookies.js"></script>
    <script src="/assets/js/CKFetch.js"></script>
    <script src="/assets/js/PopNotify.js"></script>
    <script src="/assets/js/tips.js"></script>
    <script src="/assets/js/modal.js"></script>
    <script src="/assets/js/common.js"></script>
    <script src="/assets/js/game.js"></script>
    <script src="/assets/js/errorcatcher.js"></script>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <script>
        initModal();
        initTips();
        var tipsShow;
        if (tipsShow = getUrlParam("show")) {
            showTips(tipsShow);
        }
    </script>
    <script>
        (function (window, document) {
            if ("page" in window) {
                let lp = get("#load-pending");
                if (lp) {
                    lp.classList.add("hidden");
                }
                let cc = get("#content-container");
                if (cc) {
                    cc.classList.remove("hidden");
                    cc.classList.add("anim-in");
                }

                if (window.page.onload instanceof Function) {
                    window.page.onload();
                }
                window.page.endload = new Date().valueOf();
                document.title = window.page.title;
                setCurrentPath(window.page.url);
                window.page.loadtiming = (window.page.endload - window.page.startload) / 1000;
                console.info("[LOAD TIME] 网页加载耗时 " + window.page.loadtiming + " 秒");

                page.autoexecs.forEach(e => {
                    try {
                        e.apply();
                    } catch (err) {
                        console.error("Errored while executing callback function\n", e,
                            "\n\nThe error is: ", err);
                    }
                });
                page.loaded = true;
            }
        })(window, document);
    </script>
</body>

</html>